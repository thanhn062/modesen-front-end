upstream uwsgi {
  ip_hash;
  server 127.0.0.1:9000;
}

upstream nuxt {
  ip_hash;
  server 127.0.0.1:3000;
}
server {
    listen         80 default_server; 
    server_name    modesens.com;

    if ($host = 'www.modesens.com' ) {
        rewrite ^/(.*)$ http://modesens.com/$1 permanent;
    }
    if ($host = 'www.modesens.cn' ) {
        rewrite ^/(.*)$ http://modesens.cn/$1 permanent;
    }
    if ($host = 'www.modesens.uk' ) {
        rewrite ^/(.*)$ http://modesens.uk/$1 permanent;
    }
    if ($host = 'www.modesen.ca' ) {
        rewrite ^/(.*)$ http://modesens.ca/$1 permanent;
    }
    if ($host = 'www.modesens.com.au' ) {
        rewrite ^/(.*)$ http://modesens.com.au/$1 permanent;
    }
    if ($host = 'www.modesens.kr' ) {
        rewrite ^/(.*)$ http://modesens.kr/$1 permanent;
    }
    if ($host = 'www.modesens.nl' ) {
        rewrite ^/(.*)$ http://modesens.nl/$1 permanent;
    }
    if ($host = 'www.modesens.sg' ) {
        rewrite ^/(.*)$ http://modesens.sg/$1 permanent;
    }
    if ($host = 'www.modesens.fr' ) {
        rewrite ^/(.*)$ http://modesens.fr/$1 permanent;
    }
    if ($host = 'www.modesens.es' ) {
        rewrite ^/(.*)$ http://modesens.es/$1 permanent;
    }
    if ($host = 'www.modesens.de' ) {
        rewrite ^/(.*)$ http://modesens.de/$1 permanent;
    }

    rewrite ^/static/(.*)$ https://cdn.modesens.cn/static/$1 permanent;
    rewrite ^/_nuxt/(.*)$ https://cdn.modesens.cn/static/dist/$1 permanent;
    rewrite ^/vue/(.*)$ https://modesens.com/$1 permanent;
    rewrite ^/img/(.*)$ https://cdn.modesens.cn/static/img/$1 permanent;
    rewrite ^/sitemap/(.*)$ https://s3.cn-north-1.amazonaws.com.cn/modesenscn/sitemap/$1 permanent;
    client_body_temp_path /tmp 1 2;
    client_body_buffer_size 10m;
    client_body_in_file_only off;
    client_max_body_size 20M;

    gzip on;
    gzip_http_version 1.0;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # make sure gzip does not lose large gzipped js or css files
    # see http://blog.leetsoft.com/2007/7/25/nginx-gzip-ssl
    gzip_buffers 16 8k;

    location / { 
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }   
    location = /shop/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }
    location /account/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /account/signup_success {
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }
    location /account/more {
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }
    location /barcode {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /annualreview {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /loyalty {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location ~ ^/(us|gb|au|at|be|ca|cn|cy|dk|ee|fr|fi|de|gr|hk|ie|it|jp|lv|lt|lu|mt|nl|pl|pt|no|ro|ru|sg|sk|si|kr|es|se|ch|tr|uk)/(en|zh)/(account|loyalty|barcode|annualreview)/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /static {
        expires 30d;
        autoindex on;
        add_header Cache-Control private;
        alias /opt/python/current/ladystyle/ladystyle/static;
    }
}
server {
    listen         443 default_server; 
    server_name    modesens.com;
#    access_log     /var/log/nginx/modesens_access.log;
#    error_log      /var/log/nginx/modesens_error.log;

    if ($host = 'www.modesens.com' ) {
        rewrite ^/(.*)$ https://modesens.com/$1 permanent;
    }
    if ($host = 'www.modesens.cn' ) {
        rewrite ^/(.*)$ https://modesens.cn/$1 permanent;
    }
    if ($host = 'www.modesens.uk' ) {
        rewrite ^/(.*)$ https://modesens.uk/$1 permanent;
    }
    if ($host = 'www.modesens.ca' ) {
        rewrite ^/(.*)$ https://modesens.ca/$1 permanent;
    }
    if ($host = 'www.modesens.com.au' ) {
        rewrite ^/(.*)$ https://modesens.com.au/$1 permanent;
    }
    if ($host = 'www.modesens.kr' ) {
        rewrite ^/(.*)$ https://modesens.kr/$1 permanent;
    }
    if ($host = 'www.modesens.nl' ) {
        rewrite ^/(.*)$ https://modesens.nl/$1 permanent;
    }
    if ($host = 'www.modesens.sg' ) {
        rewrite ^/(.*)$ https://modesens.sg/$1 permanent;
    }
    if ($host = 'www.modesens.fr' ) {
        rewrite ^/(.*)$ https://modesens.fr/$1 permanent;
    }
    if ($host = 'www.modesens.es' ) {
        rewrite ^/(.*)$ https://modesens.es/$1 permanent;
    }
    if ($host = 'www.modesens.de' ) {
        rewrite ^/(.*)$ https://modesens.de/$1 permanent;
    }

    rewrite ^/static/(.*)$ https://cdn.modesens.cn/static/$1 permanent;
    rewrite ^/_nuxt/(.*)$ https://cdn.modesens.cn/static/dist/$1 permanent;
    rewrite ^/vue/(.*)$ https://modesens.com/$1 permanent;
    rewrite ^/img/(.*)$ https://cdn.modesens.cn/static/img/$1 permanent;
    rewrite ^/sitemap/(.*)$ https://s3.cn-north-1.amazonaws.com.cn/modesenscn/sitemap/$1 permanent;

    ssl on;
    ssl_certificate   /etc/ssl/modesens/521bc0109c59a1fb.crt;
    ssl_certificate_key  /etc/ssl/modesens/modesens.key;
    ssl_session_timeout 5m;

    client_body_temp_path /tmp 1 2;
    client_body_buffer_size 10m;
    client_body_in_file_only off;
    client_max_body_size 20M;

    gzip on;
    gzip_http_version 1.0;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # make sure gzip does not lose large gzipped js or css files
    # see http://blog.leetsoft.com/2007/7/25/nginx-gzip-ssl
    gzip_buffers 16 8k;

    location / { 
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }   
    location = /shop/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }
    location /account/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /account/signup_success {
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }
    location /account/more {
        include uwsgi_params;
        uwsgi_pass uwsgi;
    }
    location /barcode {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /annualreview {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /loyalty {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location ~ ^/(us|gb|au|at|be|ca|cn|cy|dk|ee|fr|fi|de|gr|hk|ie|it|jp|lv|lt|lu|mt|nl|pl|pt|no|ro|ru|sg|sk|si|kr|es|se|ch|tr|uk)/(en|zh)/(account|loyalty|barcode|annualreview)/ {
        proxy_pass http://nuxt;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $host;
    }   
    location /static {
    	expires 30d;
    	autoindex on;
    	add_header Cache-Control private;
    	alias /opt/python/current/ladystyle/ladystyle/static;
    }
}
